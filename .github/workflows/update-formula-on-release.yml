name: Update Formula on Production Release

on:
  # Called by the prod repo's release workflow
  workflow_call:
    inputs:
      version:
        description: "Version to update to (e.g., v0.0.3)"
        required: true
        type: string

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (e.g., v0.0.3)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Download binaries and compute checksums
        id: checksums
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Default Supabase URL if not set in secrets
          if [ -z "$SUPABASE_URL" ]; then
            SUPABASE_URL="https://ithjwwsjhdziqnxrwydg.supabase.co"
          fi

          echo "supabase_url=$SUPABASE_URL" >> $GITHUB_OUTPUT

          # Define the platforms and architectures
          declare -A PLATFORMS=(
            ["darwin-arm64"]="darwin-arm64"
            ["darwin-amd64"]="darwin-amd64"
            ["linux-arm64"]="linux-arm64"
            ["linux-amd64"]="linux-amd64"
          )

          mkdir -p binaries

          # Download each binary and compute checksum
          for platform in "${!PLATFORMS[@]}"; do
            filename="prod-${VERSION}-${platform}.gz"
            url="${SUPABASE_URL}/storage/v1/object/public/cli-binaries/releases/${VERSION}/${filename}"
            
            echo "Downloading $filename from $url..."
            if curl -fsSL "$url" -o "binaries/${filename}"; then
              checksum=$(sha256sum "binaries/${filename}" | awk '{print $1}')
              echo "Checksum for ${platform}: ${checksum}"
              
              # Export checksum as output (replace - with _)
              output_key=$(echo "${platform}" | tr '-' '_')
              echo "checksum_${output_key}=${checksum}" >> $GITHUB_OUTPUT
              echo "filename_${output_key}=prod-${VERSION}-${platform}" >> $GITHUB_OUTPUT
            else
              echo "ERROR: Failed to download $filename"
              exit 1
            fi
          done

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SUPABASE_URL="${{ steps.checksums.outputs.supabase_url }}"

          # Get checksums
          CHECKSUM_DARWIN_ARM64="${{ steps.checksums.outputs.checksum_darwin_arm64 }}"
          CHECKSUM_DARWIN_AMD64="${{ steps.checksums.outputs.checksum_darwin_amd64 }}"
          CHECKSUM_LINUX_ARM64="${{ steps.checksums.outputs.checksum_linux_arm64 }}"
          CHECKSUM_LINUX_AMD64="${{ steps.checksums.outputs.checksum_linux_amd64 }}"

          # Get filenames (without .gz extension, as Homebrew extracts them)
          FILENAME_DARWIN_ARM64="${{ steps.checksums.outputs.filename_darwin_arm64 }}"
          FILENAME_DARWIN_AMD64="${{ steps.checksums.outputs.filename_darwin_amd64 }}"
          FILENAME_LINUX_ARM64="${{ steps.checksums.outputs.filename_linux_arm64 }}"
          FILENAME_LINUX_AMD64="${{ steps.checksums.outputs.filename_linux_amd64 }}"

          # Generate the formula file
          cat > Formula/prod.rb << FORMULA_EOF
          # Homebrew Formula for prod CLI
          # This file will be used to create the Homebrew formula

          class Prod < Formula
              desc "Production CLI tool for development workflows"
              homepage "https://github.com/pushtoprod/prod"
              version "${VERSION}"
              license "MIT"

              on_macos do
                if Hardware::CPU.arm?
                  url "${SUPABASE_URL}/storage/v1/object/public/cli-binaries/releases/${VERSION}/${FILENAME_DARWIN_ARM64}.gz"
                  sha256 "${CHECKSUM_DARWIN_ARM64}"

                  def install
                    bin.install "${FILENAME_DARWIN_ARM64}" => "prod"
                  end
                end
                if Hardware::CPU.intel?
                  url "${SUPABASE_URL}/storage/v1/object/public/cli-binaries/releases/${VERSION}/${FILENAME_DARWIN_AMD64}.gz"
                  sha256 "${CHECKSUM_DARWIN_AMD64}"

                  def install
                    bin.install "${FILENAME_DARWIN_AMD64}" => "prod"
                  end
                end
              end

              on_linux do
                if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
                  url "${SUPABASE_URL}/storage/v1/object/public/cli-binaries/releases/${VERSION}/${FILENAME_LINUX_ARM64}.gz"
                  sha256 "${CHECKSUM_LINUX_ARM64}"

                  def install
                    bin.install "${FILENAME_LINUX_ARM64}" => "prod"
                  end
                end
                if Hardware::CPU.intel?
                  url "${SUPABASE_URL}/storage/v1/object/public/cli-binaries/releases/${VERSION}/${FILENAME_LINUX_AMD64}.gz"
                  sha256 "${CHECKSUM_LINUX_AMD64}"

                  def install
                    bin.install "${FILENAME_LINUX_AMD64}" => "prod"
                  end
                end
              end
              
              # Test the installation
              test do
                system "\#{bin}/prod", "--version"
              end
          end
          FORMULA_EOF

          # Remove leading whitespace from the heredoc (dedent)
          sed -i 's/^          //' Formula/prod.rb

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="update-formula-${VERSION}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and switch to new branch
          git checkout -b "$BRANCH"

          # Stage and commit changes
          git add Formula/prod.rb
          git commit -m "Update prod formula to ${VERSION}"

          # Push the branch
          git push -u origin "$BRANCH"

          # Create the PR
          gh pr create \
            --title "Update prod formula to ${VERSION}" \
            --body "$(cat <<EOF
          This PR updates the prod Homebrew formula to version \`${VERSION}\`.

          ## Changes
          - Updated download URLs to use versioned path
          - Updated SHA256 checksums for all platforms
          - Updated binary filenames

          ## Platforms Updated
          - macOS ARM64 (Apple Silicon)
          - macOS AMD64 (Intel)
          - Linux ARM64
          - Linux AMD64

          ---
          *This PR was automatically created by the Update Formula on Production Release workflow.*
          EOF
          )" \
            --base main \
            --head "$BRANCH"
