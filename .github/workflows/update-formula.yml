name: Update Homebrew Formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., v0.0.1-staging)'
        required: true
        type: string
      supabase_url:
        description: 'Supabase URL for binary downloads'
        required: true
        type: string
        default: 'https://ciqiwllxffhbvayspynk.supabase.co'

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update formula
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SUPABASE_URL="${{ github.event.inputs.supabase_url }}"
          
          # Update the formula with new version and Supabase URL
          cat > Formula/prod.rb << EOF
          class Prod < Formula
            desc "Production CLI tool for development workflows"
            homepage "https://github.com/pushtoprod/prod"
            version "${VERSION}"
            license "MIT"
            
            # Supabase URL for binary downloads
            def supabase_url
              "${SUPABASE_URL}"
            end
            
            def install
              if OS.mac?
                if Hardware::CPU.arm?
                  system "curl", "-L", "\#{supabase_url}/storage/v1/object/public/cli-binaries/releases/latest/prod-v\#{version}-darwin-arm64.gz", "-o", "prod-darwin-arm64.gz"
                  system "gunzip", "prod-darwin-arm64.gz"
                  bin.install "prod-darwin-arm64" => "prod"
                else
                  system "curl", "-L", "\#{supabase_url}/storage/v1/object/public/cli-binaries/releases/latest/prod-v\#{version}-darwin-amd64.gz", "-o", "prod-darwin-amd64.gz"
                  system "gunzip", "prod-darwin-amd64.gz"
                  bin.install "prod-darwin-amd64" => "prod"
                end
              elsif OS.linux?
                if Hardware::CPU.arm?
                  system "curl", "-L", "\#{supabase_url}/storage/v1/object/public/cli-binaries/releases/latest/prod-v\#{version}-linux-arm64.gz", "-o", "prod-linux-arm64.gz"
                  system "gunzip", "prod-linux-arm64.gz"
                  bin.install "prod-linux-arm64" => "prod"
                else
                  system "curl", "-L", "\#{supabase_url}/storage/v1/object/public/cli-binaries/releases/latest/prod-v\#{version}-linux-amd64.gz", "-o", "prod-linux-amd64.gz"
                  system "gunzip", "prod-linux-amd64.gz"
                  bin.install "prod-linux-amd64" => "prod"
                end
              end
            end
            
            test do
              system "#{bin}/prod", "--version"
            end
          end
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Formula/prod.rb
          git commit -m "Update prod formula to version ${{ github.event.inputs.version }}" || exit 0
          git push
